node { 
    def app
    def dockerRegistry = 'https://docker-registry-default.apps.okd.robobob.ca'
    def image = 'bg-demo/bgdemo'
    def jenkinsCredentials = 'dockerOpenshift'
    def gitRepo = "https://github.com/rockoman71/ucd-blue-green.git"
    
    stage('Get Source') {
		   git gitRepo
	  }
   
    stage('Build image') {
        /* This builds the actual image; synonymous to
         * docker build on the command line */
     	//sh "sed -i "'s/ver/ver1/g'" Dockerfile"    
	//sh 'cp Dockerfile2 Dockerfile'    
        app = docker.build(image, "--build-arg ver=${BUILD_NUMBER} ./docker")
    } 
   
    stage('Push image to OpenShift') {
         sh "docker tag bg-demo/bgdemo docker-registry-default.apps.okd.robobob.ca/bg-demo/bgdemo:${BUILD_NUMBER}"
         sh "docker login -u=pusher -p=eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJiZy1kZW1vIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InB1c2hlci10b2tlbi1odm1sZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJwdXNoZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhYTBlYzdlNi03ODFkLTExZTktODhhNy0wNjg3YjYxMGM2MTkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6YmctZGVtbzpwdXNoZXIifQ.X9Th0GKfB8JrM2ZcvVMjkPai4PxHJhTr15CjHB-qdPwCBaDeB3_Irbbj3WmAVc6HxdAKdsXKgiIXY1_GEFSczpC-r2qzB3p5HWzWDX1dFxQMpiWP5VdUwpKOtXPLC0RbafvmEzmP8_taKnOGcJIlx7TFp5C6CkyLYEcujT83uUZaN8U5VSPIHCq2paEH16cwHL9A6U3kxRCYmmhiVk_89qfHhEkbG3-OKbLaScwwV9q1I8YwxOrxYlR1EjZ_bOHYf7oDBS30rkCp06Ri7Oo-wWuWH-fNcp-MinZ_FMltkCdKw1PGtR8K0CSzeJmVYFUsTejo6Asztz7Nt1UytLx-Qg https://docker-registry-default.apps.okd.robobob.ca && 	  docker push docker-registry-default.apps.okd.robobob.ca/bg-demo/bgdemo:${env.BUILD_NUMBER}"
	
         /*  docker.withRegistry(dockerRegistry,jenkinsCredentials) {
	          app.push("${env.BUILD_NUMBER}")
                  app.push("latest")
	   } */ 
     }

  stage('UrbanCode create version') {
   // class: Defines the Pipeline plug-in to define. The UCD Jenkins Pipeline plug-inâ€™s class name is UCDeployPublisher
   step([$class: 'UCDeployPublisher',
        siteName: 'ucd',
	component: [
            $class: 'com.urbancode.jenkins.plugins.ucdeploy.VersionHelper$VersionBlock',
           componentName: 'bgdemo OpenShift',
           delivery: [
                $class: 'com.urbancode.jenkins.plugins.ucdeploy.DeliveryHelper$Push',
                pushVersion: '${BUILD_NUMBER}',
		baseDir: '.',
                fileIncludePatterns: 'README.md',
                fileExcludePatterns: '',
                pushProperties: 'dockerImageTag=${BUILD_NUMBER}\ndockerImageId=x',
                pushDescription: 'Pushed from Jenkins'
	    ]	
	]	
    ])
  }
	
stage('UrbanCode Deploy to Dev') {	
   step([$class: 'UCDeployPublisher',
        siteName: 'ucd',
        deploy: [
                $class: 'com.urbancode.jenkins.plugins.ucdeploy.DeployHelper$DeployBlock',
                deployApp: 'BG OpenShift Demo',
                deployEnv: 'Dev',
                deployProc: 'Deploy Application from YAML',            
                deployVersions: 'Blue-Green Demo-bgdemo:${BUILD_NUMBER}\nbgdemo Webpage:2.2',
		//deployVersions: 'Blue-Green Demo-bgdemo:${BUILD_NUMBER}\nbgdemo Webpage:latest',
                deployOnlyChanged: false
        ]		
    ])
  }
}

